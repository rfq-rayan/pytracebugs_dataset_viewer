<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>CSV Data Viewer</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github-dark.min.css">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h2 {
            color: #333;
            border-bottom: 2px solid #007acc;
            padding-bottom: 10px;
        }
        .form-section {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            font-weight: bold;
            color: #555;
            display: block;
            margin-bottom: 5px;
        }
        select, input[type="number"] {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 8px;
            margin-top: 10px;
        }
        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .checkbox-item input[type="checkbox"] {
            margin: 0;
        }
        button {
            background: #007acc;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover {
            background: #005a9e;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
        }
        th {
            background: #007acc;
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: bold;
        }
        td {
            padding: 12px;
            border: 1px solid #ddd;
            vertical-align: top;
        }
        .code-cell {
            background: #1e1e1e;
            color: #d4d4d4;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.4;
        }
        .code-cell pre {
            margin: 0;
            background: transparent;
            border: none;
            padding: 0;
        }
        .code-cell code {
            background: transparent;
            padding: 0;
        }
        .regular-cell {
            background: white;
            max-width: 300px;
            word-wrap: break-word;
        }
        .info-text {
            color: #666;
            font-style: italic;
            text-align: center;
            padding: 20px;
        }
        .stats {
            background: #e3f2fd;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
        }
        .code-diff {
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.4;
            max-height: 300px;
            overflow-y: auto;
        }
        .diff-line {
            padding: 2px 4px;
            margin: 1px 0;
            border-radius: 2px;
            white-space: pre-wrap;
            display: flex;
        }
        .line-number {
            background: #2d2d30;
            color: #858585;
            padding: 2px 8px;
            min-width: 40px;
            text-align: right;
            border-right: 1px solid #3c3c3c;
            user-select: none;
            font-size: 11px;
        }
        .line-content {
            flex: 1;
            padding: 2px 4px;
        }
        .diff-line.equal {
            background-color: #1e1e1e;
            color: #d4d4d4;
        }
        .diff-line.modified {
            background-color: #4a4a1e;
            color: #ffff6b;
        }
        .diff-line.deleted {
            background-color: #4a1e1e;
            color: #ff6b6b;
        }
        .diff-line.added {
            background-color: #1e4a1e;
            color: #6bff6b;
        }
        .diff-line.empty {
            background-color: #2d2d30;
            color: #858585;
            font-style: italic;
        }
        .normal-code {
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.4;
            max-height: 300px;
            overflow-y: auto;
        }
        .normal-line {
            padding: 2px 4px;
            margin: 1px 0;
            display: flex;
            background-color: #1e1e1e;
            color: #d4d4d4;
        }
        .cell-container {
            position: relative;
        }
        .copy-button {
            position: absolute;
            top: 5px;
            right: 5px;
            background: #007acc;
            color: white;
            border: none;
            border-radius: 3px;
            padding: 4px 8px;
            font-size: 10px;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 10;
        }
        .copy-button:hover {
            background: #005a9e;
        }
        .cell-container:hover .copy-button {
            opacity: 1;
        }
        .copy-success {
            background: #28a745 !important;
        }
        .copy-error {
            background: #dc3545 !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>CSV Data Viewer</h2>
        
        <form method="get" class="form-section">
            <div class="form-group">
                <label>CSV File:</label>
                <select name="csv" onchange="this.form.submit()">
                    {% for csv in csv_files %}
                    <option value="{{ csv }}" {% if csv == selected_csv %}selected{% endif %}>{{ csv }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group">
                <label>Columns to show:</label>
                <div class="checkbox-group">
                    {% for col in all_columns %}
                    <div class="checkbox-item">
                        <input type="checkbox" name="columns" value="{{ col }}" 
                               {% if col in selected_columns %}checked{% endif %} 
                               onchange="this.form.submit()">
                        <span>{{ col }}</span>
                    </div>
                    {% endfor %}
                </div>
            </div>

            {% if 'traceback_type' in selected_columns %}
            <div class="form-group">
                <label>Filter by error type:</label>
                <select name="error_type" onchange="this.form.submit()">
                    <option value="">-- All Error Types --</option>
                    {% for et in error_types %}
                    <option value="{{ et }}" {% if et == selected_error_type %}selected{% endif %}>{{ et }}</option>
                    {% endfor %}
                </select>
            </div>
            {% else %}
            <input type="hidden" name="error_type" value="">
            {% endif %}

            <div class="form-group">
                <label>Code Display Mode:</label>
                <select name="diff_mode" onchange="this.form.submit()">
                    <option value="normal" {% if request.args.get('diff_mode', 'normal') == 'normal' %}selected{% endif %}>Normal View</option>
                    <option value="diff" {% if request.args.get('diff_mode') == 'diff' %}selected{% endif %}>Diff Highlighting</option>
                </select>
            </div>

            <div class="form-group">
                <label>Max rows to display:</label>
                <input type="number" name="max_rows" value="{{ max_rows }}" min="1" max="1000">
                <button type="submit">Update View</button>
            </div>
        </form>

        {% if selected_columns %}
        <div class="stats">
            <strong>Showing {{ display_rows_with_indices|length }} of {{ total_rows }} total rows</strong>
            {% if selected_error_type %}
            <br><em>Filtered by error type: {{ selected_error_type }}</em>
            {% endif %}
            {% if request.args.get('diff_mode') == 'diff' %}
            <br><strong>Diff Mode:</strong> 
            <span style="color: #ff6b6b;">Red = Deleted</span> | 
            <span style="color: #6bff6b;">Green = Added</span> | 
            <span style="color: #ffff6b;">Yellow = Modified</span>
            {% endif %}
        </div>

        <table>
            <thead>
                <tr>
                    {% for col in selected_columns %}
                    <th>{{ col }}</th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                {% for item in display_rows_with_indices %}
                {% set row = item.row %}
                {% set original_index = item.original_index %}
                <tr>
                    {% for col in selected_columns %}
                    <td class="{% if 'merge' in col.lower() or 'code' in col.lower() or 'snippet' in col.lower() %}code-cell{% else %}regular-cell{% endif %}">
                        <div class="cell-container">
                            <button class="copy-button" onclick="copyCellContent(this, '{{ loop.index0 }}', '{{ loop.index }}')">Copy</button>
                            {% if 'merge' in col.lower() or 'code' in col.lower() or 'snippet' in col.lower() %}
                                {% if request.args.get('diff_mode') == 'diff' %}
                                    {% if 'before_merge' in col.lower() %}
                                        {% set after_col = col.replace('before_merge', 'after_merge') %}
                                        {% if after_col in selected_columns and after_col in row %}
                                            {% set before_lines = row[col].split('\n') %}
                                            {% set after_lines = row[after_col].split('\n') %}
                                            {% set before_len = before_lines|length %}
                                            {% set after_len = after_lines|length %}
                                            {% set max_len = before_len if before_len > after_len else after_len %}
                                            <div class="code-diff">
                                                {% for i in range(max_len) %}
                                                    {% if i < before_len and i < after_len %}
                                                        {% if before_lines[i] == after_lines[i] %}
                                                            <div class="diff-line equal">
                                                                <div class="line-number">{{ i + 1 }}</div>
                                                                <div class="line-content">{{ before_lines[i] }}</div>
                                                            </div>
                                                        {% else %}
                                                            <div class="diff-line modified">
                                                                <div class="line-number">{{ i + 1 }}</div>
                                                                <div class="line-content">{{ before_lines[i] }}</div>
                                                            </div>
                                                        {% endif %}
                                                    {% elif i < before_len %}
                                                        <div class="diff-line deleted">
                                                            <div class="line-number">{{ i + 1 }}</div>
                                                            <div class="line-content">{{ before_lines[i] }}</div>
                                                        </div>
                                                    {% else %}
                                                        <div class="diff-line empty">
                                                            <div class="line-number"></div>
                                                            <div class="line-content"></div>
                                                        </div>
                                                    {% endif %}
                                                {% endfor %}
                                            </div>
                                        {% else %}
                                            {% set lines = row[col].split('\n') %}
                                            <div class="normal-code">
                                                {% for i in range(lines|length) %}
                                                <div class="normal-line">
                                                    <div class="line-number">{{ i + 1 }}</div>
                                                    <div class="line-content">{{ lines[i] }}</div>
                                                </div>
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                    {% elif 'after_merge' in col.lower() %}
                                        {% set before_col = col.replace('after_merge', 'before_merge') %}
                                        {% if before_col in selected_columns and before_col in row %}
                                            {% set before_lines = row[before_col].split('\n') %}
                                            {% set after_lines = row[col].split('\n') %}
                                            {% set before_len = before_lines|length %}
                                            {% set after_len = after_lines|length %}
                                            {% set max_len = before_len if before_len > after_len else after_len %}
                                            <div class="code-diff">
                                                {% for i in range(max_len) %}
                                                    {% if i < before_len and i < after_len %}
                                                        {% if before_lines[i] == after_lines[i] %}
                                                            <div class="diff-line equal">
                                                                <div class="line-number">{{ i + 1 }}</div>
                                                                <div class="line-content">{{ after_lines[i] }}</div>
                                                            </div>
                                                        {% else %}
                                                            <div class="diff-line modified">
                                                                <div class="line-number">{{ i + 1 }}</div>
                                                                <div class="line-content">{{ after_lines[i] }}</div>
                                                            </div>
                                                        {% endif %}
                                                    {% elif i < after_len %}
                                                        <div class="diff-line added">
                                                            <div class="line-number">{{ i + 1 }}</div>
                                                            <div class="line-content">{{ after_lines[i] }}</div>
                                                        </div>
                                                    {% else %}
                                                        <div class="diff-line empty">
                                                            <div class="line-number"></div>
                                                            <div class="line-content"></div>
                                                        </div>
                                                    {% endif %}
                                                {% endfor %}
                                            </div>
                                        {% else %}
                                            {% set lines = row[col].split('\n') %}
                                            <div class="normal-code">
                                                {% for i in range(lines|length) %}
                                                <div class="normal-line">
                                                    <div class="line-number">{{ i + 1 }}</div>
                                                    <div class="line-content">{{ lines[i] }}</div>
                                                </div>
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                    {% else %}
                                        {% set lines = row[col].split('\n') %}
                                        <div class="normal-code">
                                            {% for i in range(lines|length) %}
                                            <div class="normal-line">
                                                <div class="line-number">{{ i + 1 }}</div>
                                                <div class="line-content">{{ lines[i] }}</div>
                                            </div>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                {% else %}
                                    {% set lines = row[col].split('\n') %}
                                    <div class="normal-code">
                                        {% for i in range(lines|length) %}
                                        <div class="normal-line">
                                            <div class="line-number">{{ i + 1 }}</div>
                                            <div class="line-content">{{ lines[i] }}</div>
                                        </div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            {% else %}
                            {{ row[col]|replace('&', '&amp;')|replace('<', '&lt;')|replace('>', '&gt;')|replace('\n', '<br>')|safe }}
                            {% endif %}
                        </div>
                    </td>
                    {% endfor %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <div class="info-text">
            <p>Select columns to display data.</p>
        </div>
        {% endif %}
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
    <script>hljs.highlightAll();</script>
    
    <script>
        async function copyCellContent(button, rowIndex, colIndex) {
            const cellContainer = button.closest('.cell-container');
            let textContent = '';
            
            // Extract text content based on cell type
            if (cellContainer.querySelector('.code-diff, .normal-code')) {
                // For code cells, extract all line content
                const lines = cellContainer.querySelectorAll('.line-content');
                textContent = Array.from(lines).map(line => line.textContent).join('\n');
            } else {
                // For regular cells, get the text content
                textContent = cellContainer.textContent.replace('Copy', '').trim();
            }
            
            try {
                await navigator.clipboard.writeText(textContent);
                
                // Show success feedback
                const originalText = button.textContent;
                button.textContent = 'Copied!';
                button.classList.add('copy-success');
                
                setTimeout(() => {
                    button.textContent = originalText;
                    button.classList.remove('copy-success');
                }, 2000);
                
            } catch (err) {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = textContent;
                document.body.appendChild(textArea);
                textArea.select();
                
                try {
                    document.execCommand('copy');
                    
                    // Show success feedback
                    const originalText = button.textContent;
                    button.textContent = 'Copied!';
                    button.classList.add('copy-success');
                    
                    setTimeout(() => {
                        button.textContent = originalText;
                        button.classList.remove('copy-success');
                    }, 2000);
                    
                } catch (fallbackErr) {
                    // Show error feedback
                    const originalText = button.textContent;
                    button.textContent = 'Error!';
                    button.classList.add('copy-error');
                    
                    setTimeout(() => {
                        button.textContent = originalText;
                        button.classList.remove('copy-error');
                    }, 2000);
                }
                
                document.body.removeChild(textArea);
            }
        }
    </script>
</body>
</html> 
